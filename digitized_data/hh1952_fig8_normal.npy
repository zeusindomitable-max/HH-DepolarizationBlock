import numpy as np
from scipy.integrate import solve_ivp
import matplotlib.pyplot as plt
import time


# ================================================================
#   Hodgkin–Huxley 2025 Variant (T-HH) with Q10/phi Correction
# ================================================================

Cm = 1.0
gNa, gK, gL = 120.0, 35.0, 0.3       # Corrected gK
ENa, EK, EL = 50.0, -77.0, -54.4
I_STIM = 30.0
T_START, T_END_STIM = 10.0, 40.0

TSPAN = [0, 100]
TS = np.linspace(0, 100, 10000)

phi = 0.325        # Kinetic scaling factor (Q10, 6.3°C)


# ------------------------------------------------
# Voltage correction (Hodgkin–Huxley 1952 convention)
# ------------------------------------------------
def Vcorr(V):
    return V + 65.0


# ------------------------------------------------
# External current
# ------------------------------------------------
def I_stim(t):
    return I_STIM if T_START <= t <= T_END_STIM else 0.0


# ------------------------------------------------
# Rate functions with phi applied
# ------------------------------------------------
def alpha_m(Vb):
    V = Vcorr(Vb)
    if abs(25 - V) < 1e-6:
        return phi * 1.0
    return phi * 0.1 * (25 - V) / (np.exp((25 - V) / 10) - 1)

def beta_m(Vb):
    V = Vcorr(Vb)
    return phi * 4.0 * np.exp(-V / 18)

def alpha_h(Vb):
    V = Vcorr(Vb)
    return phi * 0.07 * np.exp(-V / 20)

def beta_h(Vb):
    V = Vcorr(Vb)
    return phi * 1.0 / (1 + np.exp((30 - V) / 10))

def alpha_n(Vb):
    V = Vcorr(Vb)
    if abs(10 - V) < 1e-6:
        return phi * 0.1
    return phi * 0.01 * (10 - V) / (np.exp((10 - V) / 10) - 1)

def beta_n(Vb):
    V = Vcorr(Vb)
    return phi * 0.125 * np.exp(-V / 80)


# ------------------------------------------------
# Steady-state gate values
# phi cancels internally: x_inf is temperature-invariant.
# ------------------------------------------------
def x_inf(a, b, Vb):
    av = a(Vb)
    bv = b(Vb)
    return av / (av + bv)


# ------------------------------------------------
# Core T-HH 2025 system
# ------------------------------------------------
def hh(t, y):
    V, m, h, n = y
    
    INa = gNa * m**3 * h * (V - ENa)
    IK  = gK  * n**4     * (V - EK)
    IL  = gL * (V - EL)
    
    dV = (I_stim(t) - (INa + IK + IL)) / Cm
    dm = alpha_m(V) * (1 - m) - beta_m(V) * m
    dh = alpha_h(V) * (1 - h) - beta_h(V) * h
    dn = alpha_n(V) * (1 - n) - beta_n(V) * n
    
    return [dV, dm, dh, dn]


# ================================================================
#   Simulation: Two canonical resting potentials
#   -65 mV (normal) and -40 mV (depolarized)
# ================================================================
tests = [(-65.0, "Normal"), (-40.0, "Depolarized")]
results = {}

for V0, label in tests:
    m0 = x_inf(alpha_m, alpha_m.__globals__['beta_m'], V0)
    h0 = x_inf(alpha_h, alpha_h.__globals__['beta_h'], V0)
    n0 = x_inf(alpha_n, alpha_n.__globals__['beta_n'], V0)

    y0 = [V0, m0, h0, n0]

    t0 = time.time()
    sol = solve_ivp(hh, TSPAN, y0, method="BDF", t_eval=TS)
    t_elapsed = time.time() - t0

    results[label] = {
        "sol": sol,
        "time": t_elapsed,
        "V0": V0,
        "h0": h0
    }


# ================================================================
#   Summary Output
# ================================================================
t_avg = (results["Normal"]["time"] + results["Depolarized"]["time"]) / 2
print(f"Average BDF runtime: {t_avg:.4f} s\n")

for label in results:
    r = results[label]
    peak = np.max(r["sol"].y[0, r["sol"].t >= T_START])
    print(f"Resting V = {r['V0']} mV")
    print(f"Initial h = {r['h0']:.4f}")
    print(f"Peak voltage = {peak:.2f} mV\n")


# ================================================================
#   Visualization
# ================================================================
plt.figure(figsize=(14, 5))

# Normal
plt.subplot(1, 2, 1)
N = results["Normal"]["sol"]
plt.plot(N.t, N.y[0], linewidth=2)
plt.title("Resting V = −65 mV")
plt.xlabel("Time (ms)")
plt.ylabel("Membrane potential (mV)")
plt.grid(True, linestyle=":")

# Depolarized
plt.subplot(1, 2, 2)
D = results["Depolarized"]["sol"]
plt.plot(D.t, D.y[0], linewidth=2, color="darkred")
plt.title("Resting V = −40 mV")
plt.xlabel("Time (ms)")
plt.grid(True, linestyle=":")

plt.tight_layout()
plt.show()
